<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Video Call Test Client</title>
    <style>
      body {
        font-family: sans-serif;
        padding: 20px;
      }
      .container {
        display: flex;
        gap: 20px;
      }
      .video-box {
        width: 400px;
        height: 300px;
        background: #ddd;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
      }
      video {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .controls {
        margin-top: 20px;
      }
      .log {
        margin-top: 20px;
        border: 1px solid #ccc;
        padding: 10px;
        height: 200px;
        overflow-y: scroll;
        background: #f9f9f9;
      }
    </style>
  </head>
  <body>
    <h1>Video Call Test</h1>

    <div class="controls">
      <label
        >My User ID:
        <input type="text" id="userId" placeholder="Enter Role/Name"
      /></label>
      <label>Room ID: <input type="text" id="roomId" value="room-1" /></label>
      <button onclick="joinRoom()">Join Room</button>
      <button onclick="startCall()">Start Call (Send Offer)</button>
    </div>

    <div class="container">
      <div class="video-box">
        <span>Local Video</span>
        <video id="localVideo" autoplay muted></video>
      </div>
      <div class="video-box">
        <span>Remote Video</span>
        <video id="remoteVideo" autoplay></video>
      </div>
    </div>

    <div class="log" id="logs"></div>

    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script>
      const socket = io("http://localhost:5000"); // Ensure port matches server
      let localStream;
      let peerConnection;
      const config = {
        iceServers: [{ urls: "stun:stun.l.google.com:19302" }],
      };

      const localVideo = document.getElementById("localVideo");
      const remoteVideo = document.getElementById("remoteVideo");

      function log(msg) {
        const div = document.createElement("div");
        div.textContent = `${new Date().toLocaleTimeString()} - ${msg}`;
        document.getElementById("logs").prepend(div);
      }

      // Get Camera Access
      async function initCamera() {
        try {
          localStream = await navigator.mediaDevices.getUserMedia({
            video: true,
            audio: true,
          });
          localVideo.srcObject = localStream;
          log("Camera access granted");
        } catch (err) {
          log("Error accessing camera: " + err.message);
        }
      }
      initCamera();

      // Socket Events
      socket.on("connect", () => {
        log("Connected to Socket Server: " + socket.id);
      });

      socket.on("user-connected", (userId) => {
        log(`User connected: ${userId}`);
      });

      socket.on("offer", async (payload) => {
        log("Received Offer from " + payload.caller);
        if (!peerConnection) createPeerConnection(payload.roomId);

        await peerConnection.setRemoteDescription(
          new RTCSessionDescription(payload.sdp),
        );
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);

        socket.emit("answer", {
          target: payload.caller,
          caller: document.getElementById("userId").value,
          roomId: payload.roomId,
          sdp: answer,
        });
        log("Sent Answer");
      });

      socket.on("answer", async (payload) => {
        log("Received Answer");
        await peerConnection.setRemoteDescription(
          new RTCSessionDescription(payload.sdp),
        );
      });

      socket.on("ice-candidate", async (payload) => {
        log("Received ICE Candidate");
        if (peerConnection) {
          await peerConnection.addIceCandidate(
            new RTCIceCandidate(payload.candidate),
          );
        }
      });

      function createPeerConnection(roomId) {
        peerConnection = new RTCPeerConnection(config);

        // Add local tracks
        localStream
          .getTracks()
          .forEach((track) => peerConnection.addTrack(track, localStream));

        // Handle remote track
        peerConnection.ontrack = (event) => {
          log("Remote track received");
          remoteVideo.srcObject = event.streams[0];
        };

        // Handle ICE candidates
        peerConnection.onicecandidate = (event) => {
          if (event.candidate) {
            socket.emit("ice-candidate", {
              roomId,
              candidate: event.candidate,
            });
          }
        };
      }

      function joinRoom() {
        const roomId = document.getElementById("roomId").value;
        const userId =
          document.getElementById("userId").value ||
          "User-" + Math.floor(Math.random() * 1000);
        document.getElementById("userId").value = userId; // update input if generated

        socket.emit("join-room", roomId, userId);
        log(`Joined room: ${roomId} as ${userId}`);
      }

      async function startCall() {
        const roomId = document.getElementById("roomId").value;
        const userId = document.getElementById("userId").value;
        if (!peerConnection) createPeerConnection(roomId);

        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);

        socket.emit("offer", {
          roomId,
          caller: userId,
          sdp: offer,
        });
        log("Sent Offer");
      }
    </script>
  </body>
</html>
